name: CI Build
run-name: Build on branch ${{github.ref_name}} triggered by ${{github.actor}}

on:
  push:
    branches:
      - MARP-59-Migrate-the-Marketplace-from-Ivyteam-Jenkins-to-Github
  workflow_dispatch:

env:
  DIST_FILE: ivy-website-market.tar

jobs:
  build:
    runs-on: ["ubuntu-latest"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up PHP

        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: |
            gd
            zip

      - name: Composer install
        shell: sh
        run: |
          composer install --no-dev --no-progress
          tar -cf ${{ env.DIST_FILE }} --exclude=src/web/_market --exclude=src/web/market-cache src vendor

      - name: Archive build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DIST_FILE }}
          path: |
            ${{ env.DIST_FILE }}

  run-test:
    needs: build
    runs-on: ["marketplace.axonivy.com"]
    steps:
      - name: Run test
        shell: sh
        run: |
          composer install --no-progress
          ./vendor/bin/phpunit --log-junit phpunit-junit.xml

      - name: Public test report
        uses: mikepenz/action-junit-report@v4
        if: success()
        with:
          report_paths: "**/phpunit-junit.xml"

  check-editorconfig:
    needs: run-test
    runs-on: ["marketplace.axonivy.com"]
    steps:
      - name: Editor checker
        uses: editorconfig-checker/action-editorconfig-checker@main
      - run: editorconfig-checker
